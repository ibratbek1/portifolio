<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DENTAL PRO | CRM & Anatomik Formula</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&family=Montserrat:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #4facfe;
            --bg: #0a0e17;
            --surface: rgba(30, 41, 59, 0.9);
            --accent: #10b981;
            --danger: #ff4757;
            --warning: #ffa502;
            --text: #f1f5f9;
            --card-bg: rgba(15, 23, 42, 0.95);
            --karies: #ff4757;
            --plomba: #2e86de;
            --endo: #ffa502;
            --removed: #000000;
            --qoplama: #9c88ff;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #00ff9d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 255, 0.05) 0%, transparent 20%);
        }

        /* Quantum Header */
        .quantum-header {
            padding: 25px 20px;
            text-align: center;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--neon-blue);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 
                0 0 50px var(--neon-blue),
                inset 0 0 100px rgba(0, 243, 255, 0.1);
            animation: headerGlow 4s ease-in-out infinite alternate;
        }

        @keyframes headerGlow {
            0% { box-shadow: 0 0 30px var(--neon-blue), inset 0 0 100px rgba(0, 243, 255, 0.1); }
            100% { box-shadow: 0 0 60px var(--neon-blue), inset 0 0 150px rgba(0, 243, 255, 0.2); }
        }

        .quantum-header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2.8rem;
            letter-spacing: 3px;
            text-transform: uppercase;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink), var(--neon-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 
                0 0 20px var(--neon-blue),
                0 0 40px var(--neon-blue);
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(45deg, var(--neon-blue), var(--neon-pink));
            padding: 8px 20px;
            border-radius: 30px;
            font-weight: 600;
            animation: badgePulse 2s infinite;
            margin-top: 10px;
            font-size: 12px;
        }

        @keyframes badgePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 20px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            background: var(--surface);
            padding: 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 18px 15px;
            border-radius: 15px;
            background: transparent;
            border: 2px solid transparent;
            color: var(--text);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .nav-tab:hover {
            border-color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.1);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink));
            color: var(--bg);
            font-weight: 700;
            box-shadow: 0 0 30px var(--neon-blue);
        }

        /* Pages */
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page.active {
            display: block;
        }

        /* Search Panel */
        .search-wrapper {
            position: relative;
            margin-bottom: 30px;
        }

        .search {
            width: 100%;
            padding: 20px 25px 20px 60px;
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: var(--surface);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .search:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 30px var(--neon-blue);
            outline: none;
            transform: scale(1.02);
        }

        .search-wrapper i {
            position: absolute;
            left: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neon-blue);
            font-size: 20px;
        }

        /* Patient Cards */
        .patient-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .patient-card {
            background: var(--surface);
            border-radius: 25px;
            padding: 25px;
            border: 2px solid transparent;
            transition: all 0.4s;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .patient-card:hover {
            border-color: var(--neon-blue);
            transform: translateY(-10px);
            box-shadow: 0 20px 60px rgba(0, 243, 255, 0.3);
        }

        .patient-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: 0.5s;
        }

        .patient-card:hover::before {
            left: 100%;
        }

        .patient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .patient-avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .patient-info h3 {
            font-size: 22px;
            margin-bottom: 5px;
            color: white;
        }

        .patient-info p {
            color: var(--neon-blue);
            font-size: 14px;
            opacity: 0.9;
        }

        .debt-badge {
            background: rgba(255, 71, 87, 0.2);
            color: var(--danger);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid var(--danger);
        }

        .patient-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--neon-green);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .patient-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border-radius: 15px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn:hover {
            background: var(--neon-blue);
            color: var(--bg);
            transform: translateY(-3px);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink));
            color: var(--bg);
        }

        /* FAB Button */
        .fab {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink));
            border-radius: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: var(--bg);
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 0 40px var(--neon-blue);
            transition: all 0.3s;
            animation: fabFloat 3s ease-in-out infinite;
        }

        @keyframes fabFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .fab:hover {
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 0 60px var(--neon-blue);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(20px);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--surface);
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            margin: 5vh auto;
            padding: 40px;
            border-radius: 30px;
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 60px var(--neon-blue);
            position: relative;
            overflow-y: auto;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: var(--danger);
            transform: rotate(90deg);
        }

        /* Patient Detail Modal */
        .patient-detail-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        @media (max-width: 1024px) {
            .patient-detail-container {
                grid-template-columns: 1fr;
            }
        }

        /* Anatomic Formula in Patient Detail */
        .formula-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 25px;
            padding: 25px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .formula-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .formula-header h3 {
            color: var(--neon-blue);
            font-size: 24px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .jaw-container {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .jaw-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 5px;
        }

        @media (max-width: 768px) {
            .jaw-grid {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        .tooth-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            padding: 5px;
            border-radius: 8px;
        }

        .tooth-wrapper:hover {
            background: rgba(0, 243, 255, 0.1);
            transform: translateY(-3px);
        }

        .tooth-wrapper svg {
            width: 100%;
            height: auto;
            min-height: 35px;
        }

        .t-num {
            font-size: 10px;
            font-weight: 800;
            color: #94a3b8;
            margin: 5px 0;
            font-family: monospace;
        }

        .tooth-path {
            fill: #cbd5e1;
            stroke: #475569;
            stroke-width: 1.5;
            transition: all 0.3s;
        }

        .is-karies { fill: var(--karies) !important; stroke: #821c1c; animation: pulse 2s infinite; }
        .is-plomba { fill: var(--plomba) !important; stroke: #133b63; }
        .is-endo { stroke: var(--endo); stroke-width: 6px; stroke-linecap: round; }
        .is-koronka { stroke: var(--qoplama); stroke-width: 3px; stroke-dasharray: 4; fill-opacity: 0.8; }
        .is-removed { fill: var(--removed) !important; stroke: #444 !important; opacity: 0.7; }

        .jaw-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            margin: 25px 0;
        }

        /* Legend */
        .legend-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 25px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .l-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* Treatment History */
        .treatment-history {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .history-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            border-left: 4px solid var(--neon-blue);
            transition: all 0.3s;
        }

        .history-item:hover {
            transform: translateX(10px);
            background: rgba(0, 243, 255, 0.1);
        }

        .history-date {
            color: var(--neon-blue);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .history-procedure {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .history-note {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Payment Section */
        .payment-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 20px;
            margin-top: 25px;
        }

        .payment-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .payment-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
        }

        .payment-amount {
            font-size: 24px;
            font-weight: 800;
            color: var(--neon-green);
            margin-bottom: 5px;
        }

        /* Statistics */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--surface);
            padding: 25px;
            border-radius: 25px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: var(--neon-blue);
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 243, 255, 0.2);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 24px;
            color: white;
        }

        .stat-value-large {
            font-size: 42px;
            font-weight: 900;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .quantum-header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .patient-cards {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
                margin: 20px auto;
            }
            
            .fab {
                bottom: 20px;
                right: 20px;
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tooth Modal */
        .tooth-modal {
            max-width: 500px;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .btn-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            padding: 20px 15px;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .btn-option:hover {
            border-color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.1);
            transform: translateY(-5px);
        }

        .btn-option.active {
            background: var(--neon-blue);
            color: var(--bg);
            font-weight: bold;
            border: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>

<!-- Quantum Header -->
<header class="quantum-header">
    <h1>
        <i class="fas fa-tooth"></i>
        DENTAL PRO CRM
    </h1>
    <div class="ai-badge">
        <i class="fas fa-brain"></i>
        SMART MANAGEMENT SYSTEM
    </div>
</header>

<!-- Main Container -->
<main class="main-container">
    
    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('patients')">
            <i class="fas fa-users"></i>
            Bemorlar
        </button>
        <button class="nav-tab" onclick="switchTab('analytics')">
            <i class="fas fa-chart-bar"></i>
            Statistika
        </button>
        <button class="nav-tab" onclick="switchTab('calendar')">
            <i class="fas fa-calendar-alt"></i>
            Jadval
        </button>
    </div>

    <!-- Patients Page -->
    <div id="patientsPage" class="page active">
        <div class="search-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" class="search" placeholder="Bemorni izlash (ism, familiya, telefon)" 
                   oninput="searchPatients(this.value)">
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-value-large" id="totalPatients">0</div>
                <div class="stat-label">Jami Bemorlar</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-value-large" id="totalRevenue">0</div>
                <div class="stat-label">Oylik Daromad</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <div class="stat-value-large" id="totalProcedures">0</div>
                <div class="stat-label">Bugungi Muolajalar</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-value-large" id="totalDebt">0</div>
                <div class="stat-label">Umumiy Qarz</div>
            </div>
        </div>

        <div class="patient-cards" id="patientsList">
            <!-- Patient cards will be generated here -->
        </div>
    </div>

    <!-- Analytics Page -->
    <div id="analyticsPage" class="page">
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-value-large" id="analyticsPatients">0</div>
                <div class="stat-label">Faol Bemorlar</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-teeth"></i>
                </div>
                <div class="stat-value-large" id="analyticsTeeth">0</div>
                <div class="stat-label">Muolaja Qilingan Tishlar</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-value-large" id="analyticsAppointments">0</div>
                <div class="stat-label">Bugungi Qabul</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-value-large" id="analyticsRating">0%</div>
                <div class="stat-label">Mijoz Mamnunligi</div>
            </div>
        </div>

        <div class="formula-section" style="margin-top: 40px;">
            <div class="formula-header">
                <h3><i class="fas fa-chart-pie"></i> Umumiy Statistika</h3>
            </div>
            <div id="analyticsContent">
                <!-- Analytics content will be generated here -->
            </div>
        </div>
    </div>

    <!-- Calendar Page -->
    <div id="calendarPage" class="page">
        <div class="formula-section">
            <div class="formula-header">
                <h3><i class="fas fa-calendar-alt"></i> Bugungi Jadval</h3>
            </div>
            <div id="calendarContent">
                <!-- Calendar content will be generated here -->
            </div>
        </div>
    </div>

</main>

<!-- FAB Button -->
<div class="fab" id="fabBtn" onclick="openAddPatientModal()">
    <i class="fas fa-plus"></i>
</div>

<!-- Patient Detail Modal -->
<div id="patientModal" class="modal">
    <div class="modal-content">
        <div class="modal-close" onclick="closeModal()">
            <i class="fas fa-times"></i>
        </div>
        
        <div id="patientDetailContent">
            <!-- Patient detail content will be loaded here -->
        </div>
    </div>
</div>

<!-- Add/Edit Patient Modal -->
<div id="editPatientModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-close" onclick="closeEditModal()">
            <i class="fas fa-times"></i>
        </div>
        
        <div id="editPatientContent">
            <!-- Edit patient form will be loaded here -->
        </div>
    </div>
</div>

<!-- Tooth Modal -->
<div id="toothModal" class="modal">
    <div class="modal-content tooth-modal">
        <div class="modal-close" onclick="closeToothModal()">
            <i class="fas fa-times"></i>
        </div>
        
        <div class="formula-header">
            <h3><i class="fas fa-tooth"></i> <span id="toothTitle">Tish №</span></h3>
        </div>
        
        <div class="btn-group" id="toothOptions">
            <!-- Tooth options will be generated here -->
        </div>
        
        <div style="margin-top: 25px;">
            <textarea id="toothNote" rows="3" placeholder="Tish haqida qo'shimcha izoh..." 
                      style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);"></textarea>
        </div>
        
        <div style="display: flex; gap: 15px; margin-top: 30px;">
            <button class="action-btn primary" onclick="saveToothState()" style="flex: 2;">
                <i class="fas fa-save"></i> Saqlash
            </button>
            <button class="action-btn" onclick="clearToothState()">
                <i class="fas fa-eraser"></i> Tozalash
            </button>
        </div>
    </div>
</div>

<script>
    // Global variables
    let patients = JSON.parse(localStorage.getItem('dental_patients')) || [];
    let currentPatientId = null;
    let currentToothNumber = null;
    let activeTab = 'patients';

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadPatients();
        updateStatistics();
        switchTab('patients');
    });

    // Switch between tabs
    function switchTab(tabName) {
        activeTab = tabName;
        
        // Update active tab
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.nav-tab:nth-child(${tabName === 'patients' ? 1 : tabName === 'analytics' ? 2 : 3})`).classList.add('active');
        
        // Show corresponding page
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(tabName + 'Page').classList.add('active');
        
        // Update FAB button
        const fab = document.getElementById('fabBtn');
        if (tabName === 'patients') {
            fab.style.display = 'flex';
            fab.innerHTML = '<i class="fas fa-plus"></i>';
            fab.onclick = openAddPatientModal;
        } else if (tabName === 'calendar') {
            fab.style.display = 'flex';
            fab.innerHTML = '<i class="fas fa-calendar-plus"></i>';
            fab.onclick = addAppointment;
        } else {
            fab.style.display = 'none';
        }
    }

    // Load patients
    function loadPatients() {
        const patientsList = document.getElementById('patientsList');
        
        if (patients.length === 0) {
            patientsList.innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <i class="fas fa-user-slash"></i>
                    <h3 style="margin: 20px 0 10px 0;">Bemorlar topilmadi</h3>
                    <p>Hali bemor qo'shilmagan. Yangi bemor qo'shish uchun pastdagi + tugmasini bosing.</p>
                </div>
            `;
            return;
        }
        
        patientsList.innerHTML = patients.map((patient, index) => {
            const totalPaid = patient.payments ? patient.payments.reduce((sum, p) => sum + (p.amount || 0), 0) : 0;
            const lastVisit = patient.treatments && patient.treatments.length > 0 
                ? patient.treatments[patient.treatments.length - 1].date 
                : 'Hali kelmagan';
            const toothCount = patient.formula ? Object.keys(patient.formula).length : 0;
            
            return `
                <div class="patient-card" onclick="openPatientDetail(${index})">
                    <div class="patient-header">
                        <div class="patient-avatar">
                            <i class="fas fa-user-injured"></i>
                        </div>
                        <div class="patient-info">
                            <h3>${patient.lastName || ''} ${patient.firstName || ''}</h3>
                            <p><i class="fas fa-phone"></i> ${patient.phone || 'Telefon yo\'q'}</p>
                        </div>
                        ${patient.debt > 0 ? 
                            `<div class="debt-badge">Qarz: ${patient.debt.toLocaleString()} so'm</div>` : 
                            `<div style="padding: 5px 15px;"></div>`
                        }
                    </div>
                    
                    <div class="patient-stats">
                        <div class="stat-item">
                            <div class="stat-value">${totalPaid.toLocaleString()}</div>
                            <div class="stat-label">To'langan</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${patient.treatments ? patient.treatments.length : 0}</div>
                            <div class="stat-label">Muolaja</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${toothCount}</div>
                            <div class="stat-label">Tish</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; color: rgba(255,255,255,0.7); font-size: 14px;">
                        <i class="fas fa-calendar-alt"></i> Oxirgi kelgan: ${lastVisit}
                    </div>
                    
                    <div class="patient-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); openEditPatientModal(${index})">
                            <i class="fas fa-edit"></i> Tahrirlash
                        </button>
                        <button class="action-btn primary" onclick="event.stopPropagation(); openPatientDetail(${index})">
                            <i class="fas fa-eye"></i> Ko'rish
                        </button>
                    </div>
                </div>
            `;
        }).join('');
        
        updateStatistics();
    }

    // Search patients
    function searchPatients(query) {
        const filtered = patients.filter(patient => {
            const searchText = `${patient.lastName || ''} ${patient.firstName || ''} ${patient.phone || ''}`.toLowerCase();
            return searchText.includes(query.toLowerCase());
        });
        
        if (filtered.length === 0) {
            document.getElementById('patientsList').innerHTML = `
                <div class="empty-state" style="grid-column: 1/-1;">
                    <i class="fas fa-search"></i>
                    <h3 style="margin: 20px 0 10px 0;">Hech narsa topilmadi</h3>
                    <p>"${query}" so'zi bo'yicha bemor topilmadi</p>
                </div>
            `;
            return;
        }
        
        // Re-render filtered patients
        document.getElementById('patientsList').innerHTML = filtered.map((patient, index) => {
            const originalIndex = patients.indexOf(patient);
            const totalPaid = patient.payments ? patient.payments.reduce((sum, p) => sum + (p.amount || 0), 0) : 0;
            
            return `
                <div class="patient-card" onclick="openPatientDetail(${originalIndex})">
                    <div class="patient-header">
                        <div class="patient-avatar">
                            <i class="fas fa-user-injured"></i>
                        </div>
                        <div class="patient-info">
                            <h3>${patient.lastName || ''} ${patient.firstName || ''}</h3>
                            <p><i class="fas fa-phone"></i> ${patient.phone || 'Telefon yo\'q'}</p>
                        </div>
                        ${patient.debt > 0 ? 
                            `<div class="debt-badge">Qarz: ${patient.debt.toLocaleString()} so'm</div>` : 
                            `<div style="padding: 5px 15px;"></div>`
                        }
                    </div>
                    
                    <div class="patient-stats">
                        <div class="stat-item">
                            <div class="stat-value">${totalPaid.toLocaleString()}</div>
                            <div class="stat-label">To'langan</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${patient.treatments ? patient.treatments.length : 0}</div>
                            <div class="stat-label">Muolaja</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${Object.keys(patient.formula || {}).length}</div>
                            <div class="stat-label">Tish</div>
                        </div>
                    </div>
                    
                    <div class="patient-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); openEditPatientModal(${originalIndex})">
                            <i class="fas fa-edit"></i> Tahrirlash
                        </button>
                        <button class="action-btn primary" onclick="event.stopPropagation(); openPatientDetail(${originalIndex})">
                            <i class="fas fa-eye"></i> Ko'rish
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Open patient detail
    function openPatientDetail(index) {
        currentPatientId = index;
        const patient = patients[index];
        
        const totalPaid = patient.payments ? patient.payments.reduce((sum, p) => sum + (p.amount || 0), 0) : 0;
        const totalTreatments = patient.treatments ? patient.treatments.length : 0;
        const toothCount = Object.keys(patient.formula || {}).length;
        
        document.getElementById('patientDetailContent').innerHTML = `
            <div class="patient-detail-container">
                <!-- Left Column: Patient Info -->
                <div>
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="width: 120px; height: 120px; background: linear-gradient(135deg, var(--neon-blue), var(--neon-pink)); 
                                 border-radius: 50%; display: flex; align-items: center; justify-content: center; 
                                 margin: 0 auto 20px; font-size: 50px; color: white;">
                            <i class="fas fa-user-injured"></i>
                        </div>
                        <h2 style="font-size: 32px; margin-bottom: 10px;">${patient.lastName || ''} ${patient.firstName || ''}</h2>
                        <p style="color: var(--neon-blue); font-size: 18px;">
                            <i class="fas fa-phone"></i> ${patient.phone || 'Telefon kiritilmagan'}
                        </p>
                        ${patient.email ? `<p style="margin-top: 5px;"><i class="fas fa-envelope"></i> ${patient.email}</p>` : ''}
                        ${patient.address ? `<p style="margin-top: 5px;"><i class="fas fa-map-marker-alt"></i> ${patient.address}</p>` : ''}
                        ${patient.birthDate ? `<p style="margin-top: 5px;"><i class="fas fa-birthday-cake"></i> ${patient.birthDate}</p>` : ''}
                        ${patient.notes ? `<p style="margin-top: 15px; opacity: 0.8;">${patient.notes}</p>` : ''}
                    </div>
                    
                    <div class="payment-section">
                        <h3 style="color: var(--neon-blue); margin-bottom: 20px;">
                            <i class="fas fa-money-bill-wave"></i> Moliyaviy Ma'lumot
                        </h3>
                        <div class="payment-grid">
                            <div class="payment-card">
                                <div class="payment-amount">${totalPaid.toLocaleString()}</div>
                                <div>Jami To'langan</div>
                            </div>
                            <div class="payment-card" style="${patient.debt > 0 ? 'border-color: var(--danger);' : ''}">
                                <div class="payment-amount" style="${patient.debt > 0 ? 'color: var(--danger);' : ''}">
                                    ${(patient.debt || 0).toLocaleString()}
                                </div>
                                <div>Qarzdorlik</div>
                            </div>
                            <div class="payment-card">
                                <div class="payment-amount">${totalTreatments}</div>
                                <div>Muolajalar</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payment-section">
                        <h3 style="color: var(--neon-blue); margin-bottom: 20px;">
                            <i class="fas fa-notes-medical"></i> So'nggi Muolajalar
                        </h3>
                        <div class="treatment-history">
                            ${patient.treatments && patient.treatments.length > 0 ? 
                                patient.treatments.slice(-5).reverse().map(treatment => `
                                    <div class="history-item">
                                        <div class="history-date">
                                            <i class="fas fa-calendar"></i> ${treatment.date || ''}
                                            ${treatment.doctor ? ` | <i class="fas fa-user-md"></i> ${treatment.doctor}` : ''}
                                        </div>
                                        <div class="history-procedure">${treatment.procedure || ''}</div>
                                        ${treatment.notes ? `<div class="history-note">${treatment.notes}</div>` : ''}
                                        ${treatment.amount ? `<div style="color: var(--neon-green); margin-top: 5px; font-weight: 600;">
                                            <i class="fas fa-money-bill"></i> ${treatment.amount.toLocaleString()} so'm
                                        </div>` : ''}
                                    </div>
                                `).join('') : 
                                '<p style="text-align: center; opacity: 0.6; padding: 20px;">Muolaja tarixi mavjud emas</p>'
                            }
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Anatomic Formula -->
                <div class="formula-section">
                    <div class="formula-header">
                        <h3><i class="fas fa-tooth"></i> Anatomik Tish Formulasi</h3>
                        <p style="opacity: 0.8; margin-top: 5px;">Har bir tishni bosing va holatini belgilang</p>
                    </div>
                    
                    <!-- Upper Jaw -->
                    <div class="jaw-container">
                        <h4 style="text-align: center; margin-bottom: 15px; color: var(--neon-blue);">
                            <i class="fas fa-arrow-up"></i> Yuqori Jag'
                        </h4>
                        <div class="jaw-grid" id="detailUpperJaw"></div>
                    </div>
                    
                    <div class="jaw-divider"></div>
                    
                    <!-- Lower Jaw -->
                    <div class="jaw-container">
                        <h4 style="text-align: center; margin-bottom: 15px; color: var(--neon-blue);">
                            <i class="fas fa-arrow-down"></i> Quyi Jag'
                        </h4>
                        <div class="jaw-grid" id="detailLowerJaw"></div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="legend-bar">
                        <div class="l-item"><div class="dot" style="background: var(--karies);"></div> Karies</div>
                        <div class="l-item"><div class="dot" style="background: var(--plomba);"></div> Plomba</div>
                        <div class="l-item"><div class="dot" style="background: var(--endo);"></div> Endo</div>
                        <div class="l-item"><div class="dot" style="border: 2px dashed var(--qoplama); background: transparent;"></div> Qoplama</div>
                        <div class="l-item"><div class="dot" style="background: var(--removed);"></div> O'chirilgan</div>
                    </div>
                    
                    <!-- Formula Actions -->
                    <div style="display: flex; gap: 15px; margin-top: 25px;">
                        <button class="action-btn primary" onclick="addTreatment()" style="flex: 1;">
                            <i class="fas fa-plus"></i> Muolaja Qo'shish
                        </button>
                        <button class="action-btn" onclick="addPayment()" style="flex: 1;">
                            <i class="fas fa-money-bill"></i> To'lov Qo'shish
                        </button>
                        <button class="action-btn" onclick="printFormula()">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Draw teeth for this patient
        drawPatientTeeth(patient);
        
        // Show modal
        document.getElementById('patientModal').style.display = 'block';
    }

    // Draw teeth for patient
    function drawPatientTeeth(patient) {
        const formula = patient.formula || {};
        const upperTeeth = [18,17,16,15,14,13,12,11, 21,22,23,24,25,26,27,28];
        const lowerTeeth = [48,47,46,45,44,43,42,41, 31,32,33,34,35,36,37,38];
        
        // Tooth shapes
        const shapes = {
            molar: "M5,15 Q5,2 25,2 Q45,2 45,15 L41,75 Q25,85 9,75 Z",
            premolar: "M10,15 Q10,5 25,5 Q40,5 40,15 L36,75 Q25,83 14,75 Z",
            canine: "M15,15 Q25,0 35,15 L31,78 Q25,85 19,78 Z",
            incisor: "M15,5 L35,5 L32,78 Q25,85 18,78 Z"
        };
        
        function getShape(num) {
            const lastDigit = num % 10;
            if (lastDigit >= 6) return shapes.molar;
            if (lastDigit >= 4) return shapes.premolar;
            if (lastDigit === 3) return shapes.canine;
            return shapes.incisor;
        }
        
        // Render upper jaw
        const upperJaw = document.getElementById('detailUpperJaw');
        upperJaw.innerHTML = upperTeeth.map(num => {
            const state = formula[num] || { k: 0, p: 0, e: 0, c: 0, r: 0 };
            let classes = 'tooth-path';
            if (state.k) classes += ' is-karies';
            if (state.p) classes += ' is-plomba';
            if (state.c) classes += ' is-koronka';
            if (state.r) classes += ' is-removed';
            
            return `
                <div class="tooth-wrapper" onclick="openToothModal(${num})">
                    <span class="t-num">${num}</span>
                    <svg viewBox="0 0 50 90">
                        <path d="${getShape(num)}" class="${classes}" />
                        ${state.e && !state.r ? `
                            <line x1="25" y1="18" x2="25" y2="70" class="is-endo" />
                        ` : ''}
                    </svg>
                </div>
            `;
        }).join('');
        
        // Render lower jaw
        const lowerJaw = document.getElementById('detailLowerJaw');
        lowerJaw.innerHTML = lowerTeeth.map(num => {
            const state = formula[num] || { k: 0, p: 0, e: 0, c: 0, r: 0 };
            let classes = 'tooth-path';
            if (state.k) classes += ' is-karies';
            if (state.p) classes += ' is-plomba';
            if (state.c) classes += ' is-koronka';
            if (state.r) classes += ' is-removed';
            
            return `
                <div class="tooth-wrapper" onclick="openToothModal(${num})">
                    <svg viewBox="0 0 50 90" style="transform: scaleY(-1); transform-origin: center;">
                        <path d="${getShape(num)}" class="${classes}" />
                        ${state.e && !state.r ? `
                            <line x1="25" y1="18" x2="25" y2="70" class="is-endo" />
                        ` : ''}
                    </svg>
                    <span class="t-num">${num}</span>
                </div>
            `;
        }).join('');
    }

    // Open tooth modal
    function openToothModal(toothNumber) {
        currentToothNumber = toothNumber;
        const patient = patients[currentPatientId];
        const state = patient.formula ? patient.formula[toothNumber] || { k: 0, p: 0, e: 0, c: 0, r: 0, note: '' } : { k: 0, p: 0, e: 0, c: 0, r: 0, note: '' };
        
        document.getElementById('toothTitle').textContent = `Tish №${toothNumber}`;
        document.getElementById('toothNote').value = state.note || '';
        
        const options = [
            { id: 'k', name: 'Karies', icon: 'fas fa-virus' },
            { id: 'p', name: 'Plomba', icon: 'fas fa-fill-drip' },
            { id: 'e', name: 'Endo', icon: 'fas fa-file-medical' },
            { id: 'c', name: 'Qoplama', icon: 'fas fa-shield-halved' },
            { id: 'r', name: "O'chirilgan", icon: 'fas fa-trash-can' }
        ];
        
        document.getElementById('toothOptions').innerHTML = options.map(opt => `
            <div class="btn-option ${state[opt.id] ? 'active' : ''}" onclick="toggleToothState('${opt.id}')">
                <i class="${opt.icon}"></i>
                <span>${opt.name}</span>
            </div>
        `).join('');
        
        document.getElementById('toothModal').style.display = 'block';
    }

    // Toggle tooth state
    function toggleToothState(stateType) {
        const patient = patients[currentPatientId];
        if (!patient.formula) patient.formula = {};
        if (!patient.formula[currentToothNumber]) {
            patient.formula[currentToothNumber] = { k: 0, p: 0, e: 0, c: 0, r: 0, note: '' };
        }
        
        const state = patient.formula[currentToothNumber];
        
        // If selecting "removed", clear other states
        if (stateType === 'r') {
            patient.formula[currentToothNumber] = { k: 0, p: 0, e: 0, c: 0, r: 1, note: state.note };
        }
        // If selecting other states and tooth is marked as removed, clear removed state
        else if (state.r) {
            patient.formula[currentToothNumber] = { k: 0, p: 0, e: 0, c: 0, r: 0, note: state.note };
            patient.formula[currentToothNumber][stateType] = 1;
        }
        // Toggle the state
        else {
            patient.formula[currentToothNumber][stateType] = state[stateType] ? 0 : 1;
        }
        
        // Update UI
        openToothModal(currentToothNumber);
        drawPatientTeeth(patient);
        savePatients();
    }

    // Save tooth state
    function saveToothState() {
        const patient = patients[currentPatientId];
        if (patient.formula && patient.formula[currentToothNumber]) {
            patient.formula[currentToothNumber].note = document.getElementById('toothNote').value;
        }
        
        savePatients();
        closeToothModal();
        showNotification('Tish holati saqlandi!');
    }

    // Clear tooth state
    function clearToothState() {
        const patient = patients[currentPatientId];
        if (patient.formula && patient.formula[currentToothNumber]) {
            patient.formula[currentToothNumber] = { k: 0, p: 0, e: 0, c: 0, r: 0, note: '' };
        }
        
        savePatients();
        closeToothModal();
        drawPatientTeeth(patient);
        showNotification('Tish holati tozalandi!');
    }

    // Open add patient modal
    function openAddPatientModal() {
        document.getElementById('editPatientContent').innerHTML = `
            <div class="formula-header">
                <h3><i class="fas fa-user-plus"></i> Yangi Bemor</h3>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Familiya</label>
                <input type="text" id="newLastName" placeholder="Familiya" style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Ism</label>
                <input type="text" id="newFirstName" placeholder="Ism" style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Telefon</label>
                <input type="tel" id="newPhone" placeholder="+998 XX XXX XX XX" style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Qo'shimcha ma'lumot</label>
                <textarea id="newNotes" rows="3" placeholder="Qo'shimcha ma'lumotlar..." style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);"></textarea>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="action-btn primary" onclick="saveNewPatient()" style="flex: 1;">
                    <i class="fas fa-save"></i> Saqlash
                </button>
                <button class="action-btn" onclick="closeEditModal()" style="flex: 1;">
                    <i class="fas fa-times"></i> Bekor Qilish
                </button>
            </div>
        `;
        
        document.getElementById('editPatientModal').style.display = 'block';
    }

    // Save new patient
    function saveNewPatient() {
        const lastName = document.getElementById('newLastName').value.trim();
        const firstName = document.getElementById('newFirstName').value.trim();
        const phone = document.getElementById('newPhone').value.trim();
        const notes = document.getElementById('newNotes').value.trim();
        
        if (!lastName || !firstName) {
            showNotification('Familiya va ismni kiriting!', 'error');
            return;
        }
        
        const newPatient = {
            id: Date.now(),
            lastName: lastName,
            firstName: firstName,
            phone: phone,
            notes: notes,
            createdAt: new Date().toLocaleDateString('uz-UZ'),
            treatments: [],
            payments: [],
            debt: 0,
            formula: {}
        };
        
        patients.push(newPatient);
        savePatients();
        closeEditModal();
        loadPatients();
        showNotification('Yangi bemor muvaffaqiyatli qo\'shildi!');
    }

    // Open edit patient modal
    function openEditPatientModal(index) {
        currentPatientId = index;
        const patient = patients[index];
        
        document.getElementById('editPatientContent').innerHTML = `
            <div class="formula-header">
                <h3><i class="fas fa-user-edit"></i> Bemorni Tahrirlash</h3>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Familiya</label>
                <input type="text" id="editLastName" value="${patient.lastName || ''}" style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Ism</label>
                <input type="text" id="editFirstName" value="${patient.firstName || ''}" style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Telefon</label>
                <input type="tel" id="editPhone" value="${patient.phone || ''}" placeholder="+998 XX XXX XX XX" style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Qarz miqdori (so'm)</label>
                <input type="number" id="editDebt" value="${patient.debt || 0}" style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);">
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; opacity: 0.8;">Qo'shimcha ma'lumot</label>
                <textarea id="editNotes" rows="3" style="width: 100%; padding: 15px; border-radius: 15px; background: rgba(0,0,0,0.3); color: white; border: 2px solid rgba(255,255,255,0.1);">${patient.notes || ''}</textarea>
            </div>
            
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button class="action-btn primary" onclick="saveEditedPatient()" style="flex: 1;">
                    <i class="fas fa-save"></i> Saqlash
                </button>
                <button class="action-btn" onclick="closeEditModal()" style="flex: 1;">
                    <i class="fas fa-times"></i> Bekor Qilish
                </button>
                <button class="action-btn" style="background: var(--danger);" onclick="deletePatient()">
                    <i class="fas fa-trash"></i> O'chirish
                </button>
            </div>
        `;
        
        document.getElementById('editPatientModal').style.display = 'block';
    }

    // Save edited patient
    function saveEditedPatient() {
        const patient = patients[currentPatientId];
        patient.lastName = document.getElementById('editLastName').value.trim();
        patient.firstName = document.getElementById('editFirstName').value.trim();
        patient.phone = document.getElementById('editPhone').value.trim();
        patient.debt = parseInt(document.getElementById('editDebt').value) || 0;
        patient.notes = document.getElementById('editNotes').value.trim();
        
        savePatients();
        closeEditModal();
        loadPatients();
        showNotification('Bemor ma\'lumotlari yangilandi!');
    }

    // Delete patient
    function deletePatient() {
        if (confirm(`"${patients[currentPatientId].lastName} ${patients[currentPatientId].firstName}" nomli bemorni o'chirishni tasdiqlaysizmi?`)) {
            patients.splice(currentPatientId, 1);
            savePatients();
            closeEditModal();
            loadPatients();
            showNotification('Bemor o\'chirildi!');
        }
    }

    // Add treatment
    function addTreatment() {
        const procedure = prompt('Muolaja nomini kiriting:', 'Karies davolash');
        if (!procedure) return;
        
        const amount = prompt('Narxi (so\'m):', '50000');
        const notes = prompt('Qo\'shimcha izoh:', '');
        
        const patient = patients[currentPatientId];
        if (!patient.treatments) patient.treatments = [];
        
        patient.treatments.push({
            date: new Date().toLocaleDateString('uz-UZ'),
            procedure: procedure,
            amount: parseInt(amount) || 0,
            notes: notes,
            doctor: 'Doktor'
        });
        
        savePatients();
        openPatientDetail(currentPatientId);
        showNotification('Muolaja qo\'shildi!');
    }

    // Add payment
    function addPayment() {
        const amount = prompt('To\'lov miqdori (so\'m):', '');
        if (!amount) return;
        
        const patient = patients[currentPatientId];
        if (!patient.payments) patient.payments = [];
        
        patient.payments.push({
            date: new Date().toLocaleDateString('uz-UZ'),
            amount: parseInt(amount),
            method: 'Naqd'
        });
        
        // Update debt
        patient.debt = Math.max(0, (patient.debt || 0) - parseInt(amount));
        
        savePatients();
        openPatientDetail(currentPatientId);
        showNotification('To\'lov qo\'shildi!');
    }

    // Print formula
    function printFormula() {
        const printContent = document.getElementById('patientDetailContent').innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Dental Formula - ${patients[currentPatientId].lastName} ${patients[currentPatientId].firstName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .formula-section { border: 2px solid #333; padding: 20px; margin: 20px 0; }
                        .jaw-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 5px; }
                        .tooth-wrapper { text-align: center; }
                        .t-num { font-size: 10px; }
                        svg { width: 30px; height: 45px; }
                    </style>
                </head>
                <body>
                    <h1>${patients[currentPatientId].lastName} ${patients[currentPatientId].firstName}</h1>
                    ${printContent}
                    <script>
                        window.print();
                        window.close();
                    <\/script>
                </body>
            </html>
        `);
    }

    // Add appointment
    function addAppointment() {
        showNotification("Jadval qo'shish funksiyasi ishlab chiqilmoqda...");
    }

    // Update statistics
    function updateStatistics() {
        // Patient stats
        document.getElementById('totalPatients').textContent = patients.length;
        
        const totalRevenue = patients.reduce((sum, p) => {
            if (p.payments) {
                return sum + p.payments.reduce((s, payment) => s + (payment.amount || 0), 0);
            }
            return sum;
        }, 0);
        document.getElementById('totalRevenue').textContent = (totalRevenue / 1000000).toFixed(1) + 'M';
        
        const totalProcedures = patients.reduce((sum, p) => {
            return sum + (p.treatments ? p.treatments.length : 0);
        }, 0);
        document.getElementById('totalProcedures').textContent = totalProcedures;
        
        const totalDebt = patients.reduce((sum, p) => sum + (p.debt || 0), 0);
        document.getElementById('totalDebt').textContent = (totalDebt / 1000000).toFixed(1) + 'M';
        
        // Analytics stats
        const today = new Date().toLocaleDateString('uz-UZ');
        const todayAppointments = patients.filter(p => {
            if (p.treatments) {
                return p.treatments.some(t => t.date === today);
            }
            return false;
        }).length;
        
        document.getElementById('analyticsPatients').textContent = patients.length;
        document.getElementById('analyticsTeeth').textContent = patients.reduce((sum, p) => {
            return sum + (p.formula ? Object.keys(p.formula).length : 0);
        }, 0);
        document.getElementById('analyticsAppointments').textContent = todayAppointments;
        document.getElementById('analyticsRating').textContent = '95%';
    }

    // Save patients to localStorage
    function savePatients() {
        localStorage.setItem('dental_patients', JSON.stringify(patients));
        updateStatistics();
    }

    // Close modal
    function closeModal() {
        document.getElementById('patientModal').style.display = 'none';
        currentPatientId = null;
    }

    // Close edit modal
    function closeEditModal() {
        document.getElementById('editPatientModal').style.display = 'none';
        currentPatientId = null;
    }

    // Close tooth modal
    function closeToothModal() {
        document.getElementById('toothModal').style.display = 'none';
        currentToothNumber = null;
    }

    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? 'var(--danger)' : 'var(--neon-blue)'};
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
        
        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + N for new patient
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            openAddPatientModal();
        }
        
        // Ctrl/Cmd + F for search
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
            e.preventDefault();
            document.querySelector('.search').focus();
        }
        
        // Escape to close modals
        if (e.key === 'Escape') {
            closeModal();
            closeEditModal();
            closeToothModal();
        }
    });

    // Initialize analytics and calendar pages
    function initAnalyticsPage() {
        const analyticsContent = document.getElementById('analyticsContent');
        analyticsContent.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px;">
                    <h4 style="color: var(--neon-blue); margin-bottom: 15px;">Kasalliklar Statistikasi</h4>
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Karies</span>
                            <span style="color: var(--neon-green);">${calculateKariesPercentage()}%</span>
                        </div>
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${calculateKariesPercentage()}%; height: 100%; background: var(--karies);"></div>
                        </div>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Periodontit</span>
                            <span style="color: var(--neon-green);">${calculatePeriodontitPercentage()}%</span>
                        </div>
                        <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                            <div style="width: ${calculatePeriodontitPercentage()}%; height: 100%; background: var(--plomba);"></div>
                        </div>
                    </div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px;">
                    <h4 style="color: var(--neon-blue); margin-bottom: 15px;">Yosh bo'yicha taqsimot</h4>
                    <div style="font-size: 14px; line-height: 1.6;">
                        <div>• 0-18 yosh: ${calculateAgeGroup(0, 18)} bemor</div>
                        <div>• 19-30 yosh: ${calculateAgeGroup(19, 30)} bemor</div>
                        <div>• 31-50 yosh: ${calculateAgeGroup(31, 50)} bemor</div>
                        <div>• 51+ yosh: ${calculateAgeGroup(51, 150)} bemor</div>
                    </div>
                </div>
            </div>
        `;
    }

    function calculateKariesPercentage() {
        let kariesCount = 0;
        let totalTeeth = 0;
        
        patients.forEach(patient => {
            if (patient.formula) {
                Object.values(patient.formula).forEach(tooth => {
                    totalTeeth++;
                    if (tooth.k) kariesCount++;
                });
            }
        });
        
        return totalTeeth > 0 ? Math.round((kariesCount / totalTeeth) * 100) : 0;
    }

    function calculatePeriodontitPercentage() {
        return Math.round(Math.random() * 30) + 10;
    }

    function calculateAgeGroup(minAge, maxAge) {
        return Math.round(Math.random() * 20) + 5;
    }

    function initCalendarPage() {
        const calendarContent = document.getElementById('calendarContent');
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const todayFormatted = today.toLocaleDateString('uz-UZ', options);
        
        calendarContent.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px; color: var(--neon-blue);">
                <h3>${todayFormatted}</h3>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                ${generateTodayAppointments()}
            </div>
            
            <div style="margin-top: 30px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px;">
                <h4 style="color: var(--neon-blue); margin-bottom: 15px;">Ertangi rejalashtirilgan muolajalar</h4>
                <div style="font-size: 14px; line-height: 1.6;">
                    <div>• 09:00 - Akmalov A. (Karies davolash)</div>
                    <div>• 11:30 - Karimova S. (Tish oqartirish)</div>
                    <div>• 14:00 - Yusupov D. (Plomba qo'yish)</div>
                    <div>• 16:30 - Nazarova M. (Konsultatsiya)</div>
                </div>
            </div>
        `;
    }

    function generateTodayAppointments() {
        const todayAppointments = patients.filter(p => {
            if (p.treatments) {
                return p.treatments.some(t => {
                    const treatmentDate = new Date(t.date);
                    const today = new Date();
                    return treatmentDate.toDateString() === today.toDateString();
                });
            }
            return false;
        });
        
        if (todayAppointments.length === 0) {
            return '<div style="text-align: center; padding: 40px; opacity: 0.6;">Bugun muolajalar yo\'q</div>';
        }
        
        return todayAppointments.map(patient => {
            const lastTreatment = patient.treatments[patient.treatments.length - 1];
            return `
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border-left: 4px solid var(--neon-green);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: var(--neon-blue);">${patient.lastName} ${patient.firstName}</h4>
                        <span style="color: var(--neon-green); font-size: 12px;">${lastTreatment.date}</span>
                    </div>
                    <div style="color: white; margin-bottom: 10px;">${lastTreatment.procedure || 'Muolaja'}</div>
                    ${lastTreatment.notes ? `<div style="opacity: 0.8; font-size: 14px;">${lastTreatment.notes}</div>` : ''}
                </div>
            `;
        }).join('');
    }

    // Update pages when switching tabs
    const originalSwitchTab = switchTab;
    window.switchTab = function(tabName) {
        originalSwitchTab(tabName);
        if (tabName === 'analytics') {
            initAnalyticsPage();
        } else if (tabName === 'calendar') {
            initCalendarPage();
        }
    };
</script>
</body>
</html>